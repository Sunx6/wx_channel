name: Build and Release

on:
  push:
    # 只有当推送标签（如 v1.0.0, v2.1.5）时才触发
    tags:
      - "v*"

# ⚠️ 必须赋予写权限，否则 Action 无法创建 Release
permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      # ---------------------------------------
      # 1. 构建 Mac M芯片 (ARM64)
      # ---------------------------------------
      - name: Build for Mac (ARM64)
        env:
          GOOS: darwin
          GOARCH: arm64
          CGO_ENABLED: 0
        run: go build -v -o wx_channel_darwin_arm64 ./...

      # ---------------------------------------
      # 2. 构建 Windows (AMD64)
      # ---------------------------------------
      - name: Build for Windows
        env:
          GOOS: windows
          GOARCH: amd64
          CGO_ENABLED: 0
        # 注意：Windows 程序通常需要 .exe 后缀
        run: go build -v -o wx_channel_windows_amd64.exe ./...

      # ---------------------------------------
      # 3. 创建 Release 并上传文件
      # ---------------------------------------
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          # 这里列出所有要上传的文件
          files: |
            wx_channel_darwin_arm64
            wx_channel_windows_amd64.exe
          # 是否设为草稿（设为 true 则发布后只有你能看到，需要手动点发布）
          draft: false
          # 是否为预发布版本
          prerelease: false
